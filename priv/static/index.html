<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/purecss@1.0.1/build/pure-min.css"
      integrity="sha384-oAOxQR6DkCoMliIh8yFnu25d7Eq/PHS21PClpwjOTeU2jRSq11vu66rf90/cZr47"
      crossorigin="anonymous"
    />
    <script type="module">
      import {
        h,
        Component,
        render,
        createContext
      } from "https://unpkg.com/preact@latest?module";

      import {
        useState,
        useCallback,
        useReducer,
        useContext,
        useRef
      } from "https://unpkg.com/preact@latest/hooks/dist/hooks.module.js?module";

      import htm from "https://unpkg.com/htm?module";

      const rainbow = [
        "#9400d3",
        "#4b0082",
        "#0000ff",
        "#00ff00",
        "#ffff00",
        "#ff7f00",
        "#ff0000",
        "#000000"
      ];

      const html = htm.bind(h);

      function getRainbow() {
        return new Array(8)
          .fill()
          .map((_, i) =>
            new Array(4).fill({ visibile: true, color: rainbow[i] })
          );
      }

      const Context = createContext();

      function Provider({ reducers, initialState, children }) {
        const [state, dispatch] = useReducer(reducers, initialState);

        return html`
          <${Context.Provider} value=${{ state, dispatch }}>
            ${children}
          <//>
        `;
      }

      const connect = component => props => {
        const { state, dispatch } = useContext(Context);

        return component({
          ...props,
          ...state,
          dispatch
        });
      };

      const Row = ({ leds, y }) =>
        html`
          <div class="row-${y}">
            ${leds.map(
              (led, x) =>
                html`
                  <${Led} ...${led} y=${y} x=${x} />
                `
            )}
          </div>
        `;

      function reducers(state, action) {
        switch (action.type) {
          case "COPY_FROM_ORIGIN":
            return {
              ...state,
              grid: Array(8)
                .fill()
                .map(() => Array(4).fill(state.grid[0][0]))
            };
          case "SET_RAINBOW":
            return {
              ...state,
              grid: getRainbow()
            };
          case "SET_COLOR":
             const { color, x, y } = action.payload;
            state.grid[y][x] = color;
            return {
              ...state
            };
          default:
            return state;
        }
      }

      const App = connect(({ grid, dispatch }) => {
        const copyFromOrigin = () => dispatch({ type: "COPY_FROM_ORIGIN" });
        const setRainbow = () => dispatch({ type: "SET_RAINBOW" });

        return html`
          ${grid.map(
            (row, y) =>
              html`
                <${Row} leds=${row} y=${y} />
              `
          )}
          <button onClick=${copyFromOrigin}>Copy from 0,0</button>
          <button onClick=${setRainbow}>Rainbow</button>
        `;
      });

      const Led = connect(({ color, dispatch, x, y }) => {
        const input = useRef(null);
        const setColor = () =>
          dispatch({
            type: "SET_COLOR",
            payload: { color: input.current && input.current.value, x, y }
          });

        return html`
          <input
            ref=${input}
            type="color"
            value=${color}
            onChange=${setColor}
          />
        `;
      });

      render(
        html`
          <${Provider}
            reducers=${reducers}
            initialState=${{ grid: getRainbow() }}
          >
            <${App} />
          <//>
        `,
        document.body
      );
    </script>
  </head>
  <body></body>
</html>
